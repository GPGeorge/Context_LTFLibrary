@using LTF_Library_V1.DTOs
@using LTF_Library_V1.Services
@using Microsoft.AspNetCore.Components.Authorization
@inject IUserService UserService
@inject AuthenticationStateProvider AuthenticationStateProvider

@inject NavigationManager Navigation
@if (IsAuthenticated)
{
    <div class="admin-nav" style="margin-top: 20px;">
        <div style="text-align: center;">
            <p style="margin-bottom: 10px; color: #2c3e50;">
                Welcome, <strong>@CurrentUser?.FullName</strong>
            </p>
            <div style="display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                @if (IsAdmin)
                {
                    <a href="admin" class="admin-link">Admin Dashboard</a>
                }
                else if (IsStaff)
                {
                    <a href="admin" class="admin-link">Staff Dashboard</a>
                }
                <button @onclick="LogoutAsync" class="admin-link" style="background: none; border: 1px solid #dc3545; color: #dc3545;">
                    Logout
                </button>
            </div>
        </div>
    </div>
}
else
{
    <div style="text-align: center; margin-top: 20px;">
        <a href="login" class="admin-link">Staff Login</a>
    </div>
}
@* 
@if (IsAuthenticated)
{
    <div class="admin-nav" style="margin-top: 20px;">
        <div style="text-align: center;">
            <p style="margin-bottom: 10px; color: #2c3e50;">
                Welcome, <strong>@CurrentUser?.FullName</strong>
            </p>
            <div style="display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                @if (IsAdmin)
                {
                    <a href="/admin" class="admin-link">Admin Dashboard</a>
                }
                else if (IsStaff)
                {
                    <a href="/admin" class="admin-link">Staff Dashboard</a>
                }
                <button @onclick="LogoutAsync" class="admin-link" style="background: none; border: 1px solid #dc3545; color: #dc3545;">
                    Logout
                </button>
            </div>
        </div>
    </div>
}
else
{
    <div style="text-align: center; margin-top: 20px;">
        <a href="/login" class="admin-link">Staff Login</a>
    </div>
} *@

@code {
    private bool IsAuthenticated = false;
    private bool IsAdmin = false;
    private bool IsStaff = false;
    private UserDto? CurrentUser;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        IsAuthenticated = authState.User.Identity?.IsAuthenticated ?? false;

        if (IsAuthenticated)
        {
            try
            {
                CurrentUser = await UserService.GetCurrentUserAsync();
                if (CurrentUser != null)
                {
                    IsAdmin = CurrentUser.Roles.Contains("Admin");
                    IsStaff = CurrentUser.Roles.Contains("Staff") || IsAdmin;
                }
            }
            catch
            {
                // If there's an error getting user info, treat as not authenticated
                IsAuthenticated = false;
            }
        }
    }

    private async Task LogoutAsync()
    {
        await UserService.LogoutAsync();
        // Navigation.NavigateTo("/", forceLoad: true);
        Navigation.NavigateTo("", forceLoad: true);  // Empty string = current subsite root
    }
}